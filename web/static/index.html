<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <title>Doc-Image-Tool Web 原型</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
      body{font-family:Inter,Arial,Helvetica,sans-serif;margin:20px;color:#222}
      .row{display:flex;gap:12px;align-items:center}
      label{display:block;margin-top:8px}
      #result{max-width:100%;border:1px solid #eee;padding:6px;background:#fafafa}
      .jobs{margin-top:18px;border-collapse:collapse;width:100%}
      .jobs th,.jobs td{border:1px solid #eee;padding:8px;text-align:left}
      .smallimg{height:80px;border:1px solid #ccc}
      button{padding:8px 12px;border-radius:6px;border:1px solid #ddd;background:#fff;cursor:pointer}
      button.primary{background:#0b66ff;color:#fff;border-color:#0b66ff}
      .spinner{display:inline-block;width:16px;height:16px;border:2px solid #ccc;border-top-color:#0b66ff;border-radius:50%;animation:spin 1s linear infinite}
      @keyframes spin{to{transform:rotate(360deg)}}
    </style>
  </head>
  <body>
    <h2>Doc-Image-Tool Web 原型</h2>

    <div class="row">
      <input id="file" type="file" accept="image/*">
      <select id="action">
        <option value="bleach">漂白</option>
        <option value="orientation">文字方向矫正</option>
        <option value="sharpen">清晰增强</option>
        <option value="denoise">笔记去噪美化</option>
        <option value="shadow">去阴影</option>
        <option value="dewarp">扭曲矫正</option>
        <option value="trim">切边增强</option>
      </select>
      <label style="margin:0"><input type="radio" name="mode" value="sync" checked> 同步</label>
      <label style="margin:0"><input type="radio" name="mode" value="async"> 异步</label>
      <button id="submit" class="primary">提交</button>
      <button id="clearAll">清空结果</button>
    </div>

    <div id="statusArea" style="margin-top:12px"></div>

    <h3 style="margin-top:18px">单次结果</h3>
    <div id="singleResult"> <img id="result" alt="result"/> <a id="downloadSingle" style="display:none;margin-left:8px"></a> </div>

    <h3 style="margin-top:18px">任务列表</h3>
    <table class="jobs" id="jobsTable">
      <thead><tr><th>Job ID</th><th>动作</th><th>状态</th><th>预览</th><th>操作</th></tr></thead>
      <tbody></tbody>
    </table>

    <div style="margin-top:12px">
      <button id="downloadAll">下载全部结果 (ZIP)</button>
    </div>

    <script>
      const submitBtn = document.getElementById('submit');
      const fileInput = document.getElementById('file');
      const actionSel = document.getElementById('action');
      const statusArea = document.getElementById('statusArea');
      const jobsTableBody = document.querySelector('#jobsTable tbody');
      const singleResult = document.getElementById('result');

      const jobs = {}; // job_id -> {action, intervalId}

      function setStatus(msg, busy=false){
        statusArea.innerHTML = busy ? `<span class="spinner"></span> ${msg}` : msg;
      }

      async function pollStatus(jobId, row){
        try{
          const r = await fetch(`/status/${jobId}`);
          const js = await r.json();
          const st = js.status || js;
          row.querySelector('.st').textContent = st;
          if(st === 'finished'){
            clearInterval(jobs[jobId].intervalId);
            // fetch result
            const res = await fetch(`/result/${jobId}`);
            if(res.ok){
              const blob = await res.blob();
              const url = URL.createObjectURL(blob);
              row.querySelector('.preview').src = url;
                  const dl = row.querySelector('.download');
                  dl.href = `/download/${jobId}`;
                  dl.setAttribute('download', `${jobId}.jpg`);
                  dl.style.display = 'inline-block';
                  dl.textContent = '下载';
            }
          } else if(st === 'error'){
            clearInterval(jobs[jobId].intervalId);
          }
        }catch(e){
          row.querySelector('.st').textContent = 'error';
          clearInterval(jobs[jobId].intervalId);
        }
      }

      submitBtn.onclick = async ()=>{
        const f = fileInput.files[0];
        if(!f){alert('请选择图片');return}
        const mode = document.querySelector('input[name=mode]:checked').value;
        const action = actionSel.value;
        const fd = new FormData();
        fd.append('file', f);
        fd.append('action', action);

        setStatus('上传中...', true);
        try{
          if(mode === 'sync'){
            const res = await fetch('/process', {method:'POST', body:fd});
            if(!res.ok){setStatus('处理失败: '+await res.text());return}
              const blob = await res.blob();
              const url = URL.createObjectURL(blob);
              singleResult.src = url;
              const dlSingle = document.getElementById('downloadSingle');
              dlSingle.href = url;
              dlSingle.setAttribute('download', 'result.jpg');
              dlSingle.style.display = 'inline-block';
              dlSingle.textContent = '下载';
              setStatus('同步处理完成');
          } else {
            const res = await fetch('/process_async', {method:'POST', body:fd});
            if(!res.ok){setStatus('提交失败: '+await res.text());return}
            const js = await res.json();
            const jobId = js.job_id;
            setStatus('已提交 '+jobId);
            // add row
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${jobId}</td><td>${action}</td><td class="st">queued</td><td><img class="preview smallimg"/></td><td><a class="download" style="display:none"></a></td>`;
            jobsTableBody.prepend(tr);
            // start polling
            jobs[jobId] = {action, intervalId: setInterval(()=>pollStatus(jobId,tr), 1000)};
          }
        }catch(e){
          setStatus('请求错误: '+e);
        }finally{
          setTimeout(()=>setStatus(''), 1200);
        }
      }

      document.getElementById('clearAll').onclick = async ()=>{
        jobsTableBody.innerHTML = '';
        singleResult.src = '';
        const dlSingle = document.getElementById('downloadSingle');
        dlSingle.style.display = 'none';
        setStatus('已清空');
      }

      document.getElementById('downloadAll').onclick = async ()=>{
        const res = await fetch('/download_all');
        if(!res.ok){ alert('没有可下载的文件'); return }
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'results.zip';
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }
    </script>
  </body>
</html>
